<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Nixを用いたWebサーバ環境の構築手順 | minenaの部屋</title>
  <meta property="og:type" content="website">
  <meta property="og:title" content="minenaのPortfolio">
  <meta property="og:url" content="https://nmst0811.github.io/portfolio/">
  <meta property="og:description" content="Nuxt.jsでWebサイトを作ってみた。">
  <meta property="og:site_name" content="minenaのPortfolio">
  <meta property="og:locale" content="ja_JP">
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="apple-touch-icon" href="./images/icon.svg" sizes="180x180">
  <link rel="icon" href="./images/icon.svg" sizes="192x192" type="image/png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New&display=swap" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js" defer></script>
</head>

<body>
  <header>
        <h1 class="headline">
          <a>minenaの部屋</a>
        </h1>
        <ul class="nav-list">
          <li class="nav-list-item"><a href="#About">About me</a></li>
          <li class="nav-list-item"><a href="#Works">Works</a></li>
          <li class="nav-list-item"><a href="https://nmst0811.github.io/TryToNuxt/">Article</a></li>
          <li class="nav-list-item"><a href="#Contact">Contact</a></li>
        </ul>
      </header>

  <main id="contents">
    <br>
    <h2>Nixを用いたWebサーバ環境の構築手順</h2>
    <br>

    <h3>1. 目的と完成条件の定義</h3>
    <h4>目的:</h4>
    <ul>
      <li>OS標準のパッケージ管理（apt）に依存せず、Nixを用いてプロジェクト単位で独立したWebサーバ環境（Nginx）を構築する。</li>
      <li>構成管理をコード化（IaC）し、手順書と設定ファイルがあれば誰でも全く同じ環境を再現できる状態にする。</li>
    </ul>
    <h4>完成条件:</h4>
    <ul>
      <li>Raspberry Pi 上で <code>http://example.com</code>（ポート80）にアクセスし、指定したWebページが表示されること。</li>
      <li><code>http://example.com/health</code> にアクセスすると、ステータスコード 200 と共に <code>'OK'</code> が返されること。</li>
    </ul>

    <br><br>

    <h3>3. 事前準備</h3>
    <p>本手順は Raspberry Pi OS (64-bit) を前提とします。</p>

    <br>

    <h4>3.1. ユーザーと権限</h4>
    <ul>
      <li>既存のユーザー（例: pi または作成したユーザー）を使用。</li>
      <li>sudo 権限が必須。</li>
    </ul>

    <br>

    <h4>3.2. 既存Webサーバの停止</h4>
    <p>ポート80の競合を防ぐため、デフォルトでインストールされているApacheを停止・無効化します。</p>
    <pre><code>sudo systemctl stop apache2
sudo systemctl disable apache2</code></pre>

    <br>

    <h4>3.3. ファイアウォール設定 (UFW)</h4>
    <p>Raspberry Pi OSにはデフォルトでUFWが入っていない場合があるため、導入して設定を行います。</p>
    <pre><code># インストール
sudo apt update && sudo apt install ufw -y

# ルール設定（SSHとHTTPのみ許可）
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw limit ssh
sudo ufw allow 80/tcp

# 有効化（SSH切断警告が出るが 'y' で進む）
sudo ufw enable</code></pre>

    <br>

    <h4>3.4. Nixのインストールと設定</h4>
    <p>マルチユーザーモードでインストールし、Flakes機能を有効化します。</p>
    <pre><code># 1. インストーラー実行
sh <(curl -L https://nixos.org/nix/install) --daemon

# 2. 一度ログアウトして再ログイン（パスを通すため）
exit
# (再接続後) nix --version でバージョンが表示されることを確認

# 3. Flakes機能の有効化
sudo mkdir -p /etc/nix
echo "experimental-features = nix-command flakes" | sudo tee -a /etc/nix/nix.conf
sudo systemctl restart nix-daemon</code></pre>

    <br><br>

    <h3>4. 構築手順（再現可能性重視）</h3>

    <h4>4.1. プロジェクトディレクトリの作成</h4>
    <p>管理のしやすさと権限分離のため、<code>/opt</code> 配下に構築します。</p>
    <pre><code># ディレクトリ作成と権限変更
sudo mkdir -p /opt/webserver
sudo chown $USER:$USER /opt/webserver
cd /opt/webserver

# 必要なサブディレクトリの作成
mkdir html conf logs</code></pre>

    <br>

    <h4>4.2. 依存関係定義ファイル (flake.nix)</h4>
    <p>
      Raspberry Pi 400 (ARMアーキテクチャ) 用に <code>aarch64-linux</code> を指定した完全版を作成します。<br>
      ファイルパス: <code>/opt/webserver/flake.nix</code>
    </p>
    <pre><code>{
  description = "Nginx for Raspberry Pi 400";

  inputs = {
    # 再現性確保のためnixpkgsのバージョンを固定
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-23.11";
  };

  outputs = { self, nixpkgs }:
    let
      # 【重要】RPi 400用のアーキテクチャ指定
      system = "aarch64-linux";
      pkgs = nixpkgs.legacyPackages.${system};
    in
    {
      packages.${system}.default = pkgs.nginx;
    };
}</code></pre>

    <br>

    <h4>4.3. Webコンテンツの作成</h4>
    <p>
      表示確認用のHTMLファイルを作成します。<br>
      ファイルパス: <code>/opt/webserver/html/index.html</code>
    </p>
    <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Nix Web Server&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Success! example.com Server Block is working!&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>

    <br>

    <h4>4.4. Nginx設定ファイル (nginx.conf)</h4>
    <p>
      サーバーブロックを用いてドメイン設定とヘルスチェックを定義する完全版です。Nix環境では標準のパスを見に行かないため、絶対パスで指定する箇所に注意します。<br>
      ファイルパス: <code>/opt/webserver/nginx.conf</code>
    </p>
    <pre><code>events {
    worker_connections 1024;
}

http {
    # 基本的なMIMEタイプ設定（簡易版）
    default_type  application/octet-stream;
    
    server {
        # ポート80でリッスン（サーバーブロック）
        listen 80;
        
        # ドメイン名設定
        server_name example.com;

        # ドキュメントルート（絶対パスで指定）
        root /opt/webserver/html;
        index index.html;

        location / {
            try_files $uri $uri/ =404;
        }

        # 【完成条件】ヘルスチェック用エンドポイント
        location /health {
            return 200 "OK";
        }
    }
}</code></pre>

    <br>

    <h4>4.5. ビルドとリンク生成</h4>
    <p>定義ファイルに基づきNginxをビルドし、シンボリックリンク <code>result</code> を生成します。</p>
    <pre><code>cd /opt/webserver
nix build .</code></pre>
    <p>※ 成功するとカレントディレクトリに <code>result</code> リンクが生成される。</p>

    <br>

    <h4>4.6. サービスの永続化 (Systemd)</h4>
    <p>
      OS再起動時も自動で立ち上がるよう、Unitファイルを作成します。<br>
      ファイルパス: <code>/etc/systemd/system/nix-nginx.service</code> (sudoで作成)
    </p>
    <pre><code>[Unit]
Description=Nginx Web Server via Nix
After=network.target

[Service]
Type=forking
# Nixでビルドしたバイナリ(result)経由で起動
ExecStart=/opt/webserver/result/bin/nginx -c /opt/webserver/nginx.conf
ExecReload=/opt/webserver/result/bin/nginx -c /opt/webserver/nginx.conf -s reload
KillSignal=SIGQUIT
KillMode=mixed
Restart=on-failure

[Install]
WantedBy=multi-user.target</code></pre>

    <br>

    <h4>4.7. ログディレクトリの準備と起動</h4>
    <p>Nginxがデフォルトで書き込もうとするログディレクトリを事前に作成してからサービスを起動します。</p>
    <pre><code># ログディレクトリ作成
sudo mkdir -p /var/log/nginx

# Systemd設定の読み込みと起動
sudo systemctl daemon-reload
sudo systemctl enable --now nix-nginx</code></pre>
<br>
<img src="./images/01.jpg" style="max-width: 100%; height: auto;">


    <br><br>

    <h3>5. 動作確認と検証</h3>

    <h4>5.1. 名前解決の偽装 (Hosts設定)</h4>
    <p>Raspberry Pi自身からのアクセスで <code>example.com</code> を解決できるようにします。</p>
    <pre><code># /etc/hosts の末尾に追記
echo "127.0.0.1 example.com" | sudo tee -a /etc/hosts</code></pre>

    <br>

    <h4>5.2. 疎通確認とヘルスチェック</h4>
    <p>以下のコマンドを実行し、期待通りの結果が返るか確認します。</p>
    
    <p><strong>トップページの確認</strong></p>
    <pre><code>curl http://example.com</code></pre>
    <p>判定: <code>&lt;h1&gt;Welcome to example.com&lt;/h1&gt;</code> を含むHTMLが表示されれば成功。</p>

    <p><strong>ヘルスチェック（完成条件）</strong></p>
    <pre><code>curl http://example.com/health</code></pre>
    <p>判定: <code>OK</code> という文字列のみが表示されれば成功。</p>

    <br>

    <h4>5.3. ログ確認</h4>
    <p>サービスが正常に稼働しているかログを確認します。</p>
    <pre><code>sudo systemctl status nix-nginx</code></pre>
    <br>
    <img src="./images/02.jpg" style="max-width: 100%; height: auto;">

    <br><br>

    <h3>6. トラブルシューティング</h3>
    <table border="1" cellpadding="10" cellspacing="0" style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
      <thead>
        <tr style="background-color: #f2f2f2;">
          <th>現象</th>
          <th>原因</th>
          <th>対処法</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Address already in use エラー</td>
          <td>ポート80が既にApacheなどで使われている</td>
          <td><code>sudo systemctl stop apache2</code> を実行し、既存Webサーバを停止する。</td>
        </tr>
        <tr>
          <td>open() ".../error.log" failed</td>
          <td>ログ出力先のディレクトリが存在しない</td>
          <td><code>sudo mkdir -p /var/log/nginx</code> を実行してディレクトリを作成する。</td>
        </tr>
        <tr>
          <td>experimental Nix feature...</td>
          <td>NixのFlakes機能が有効になっていない</td>
          <td>手順3.4の通り <code>/etc/nix/nix.conf</code> に設定を追記し、nix-daemon を再起動する。</td>
        </tr>
        <tr>
          <td>ビルド時間が異常に長い</td>
          <td>32-bit版OSを使用している可能性がある</td>
          <td><code>uname -m</code> を実行。armv7l (32bit) の場合、バイナリ配布がないためコンパイルが走る。64bit版OS推奨。</td>
        </tr>
      </tbody>
    </table>

    <br><br>

    <h3>7. セキュリティ配慮</h3>
    <ul>
      <li><strong>権限の分離:</strong> 構築作業自体は一般ユーザーのホームまたは <code>/opt</code> 配下で行い、システム領域（<code>/usr/bin</code>等）を汚さない設計とした。</li>
      <li><strong>ファイアウォール:</strong> UFWにより、必要なポート（80, 22）以外を閉鎖し、外部からの不要なアクセスを遮断している。</li>
      <li><strong>更新方針:</strong> <code>flake.nix</code> 内の nixpkgs リビジョンを変更して <code>nix build</code> し直すことで、OS全体に影響を与えずにWebサーバのバージョンアップが可能。</li>
    </ul>

    <br><br>

    <h3>8. 参考資料</h3>
    <ul>
      <li><a href="https://nixos.org/download/#nix-install-linux" target="_blank">Nix Download</a></li>
      <li><a href="https://debslink.hatenadiary.jp/entry/20250503/1746235454" target="_blank">NixOSでnginxによるWebサーバの構築</a></li>
      <li><a href="https://qiita.com/riita10069/items/5d36dfeb756e3b6c4978" target="_blank">初心者でも10分で分かるnginxの役割と使い方</a></li>
    </ul>

    <br>
  </main>
  <footer class="footer02">
    <ul class="menu">
      <li><a href="https://nmst0811.github.io/portfolio/">About me</a></li>
      <li><a href="https://nmst0811.github.io/portfolio/#Works">Works</a></li>
      <li><a href="#Works">Article</a></li>
      <li><a href="https://nmst0811.github.io/portfolio/#Contact">Contact</a></li>
    </ul>
    <p class="copyright">&copy; minena/Umamimi</p>
  </footer>
</body>
</html>
